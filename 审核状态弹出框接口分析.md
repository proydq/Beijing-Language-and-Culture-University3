# 审核状态弹出框接口分析

## 📋 概述

在借用管理的"我的预约"界面中，点击"审核状态"列时会弹出审核详情对话框。目前该功能使用的是前端模拟数据，需要调用后端接口获取真实的审批历史数据。

## 🔍 现状分析

### 前端实现分析

**文件位置**: `src/components/RoomBooking/Booking/MyBookings.vue`

```javascript
// 当前使用模拟数据的实现
function handleViewAuditDetail(row) {
  const base = bookingBaseInfo[row.id] || {}
  currentRecord.value = {
    reservationTitle: base.reservationName || row.reservationName,
    userName: base.applicant || row.applicantName,
    borrowPeriodText: base.reservationPeriod || row.reservationPeriod,
    borrowDesc: base.description || row.description,
    participants: base.participants ? base.participants.split(', ') : [],
    remark: base.remark || '',
    approvalStatus: base.approvalStatus || row.approvalStatus,
    approvalSteps: auditDetailData[row.id] || [], // 模拟数据
  }
  auditDialogVisible.value = true
}
```

**弹出框组件**: `src/components/RoomBooking/Booking/AuditDetailDialog.vue`
- 显示预约基本信息和审批步骤
- 审批步骤表格包含：审批层级、审批人、确认审批人、审批时间、审批意见

## ✅ 已存在的后端接口

### 1. 获取审批历史接口

**接口路径**: `GET /api/room-booking/approval-history/{bookingId}`

**控制器**: `RoomBookingApprovalController.java`
```java
@GetMapping("/approval-history/{bookingId}")
public ResponseEntity<List<ApprovalHistoryResponse>> getApprovalHistory(@PathVariable String bookingId)
```

**服务实现**: `RoomBookingServiceImpl.java`
```java
@Override
public List<ApprovalHistoryResponse> getApprovalHistory(String bookingId)
```

## 📝 接口详细规格

### 请求参数

| 参数名    | 类型   | 位置 | 必填 | 说明   |
|-----------|--------|------|------|--------|
| bookingId | String | Path | 是   | 预约ID |

### 请求示例

```bash
GET /api/room-booking/approval-history/booking123456
Authorization: Bearer {token}
```

### 响应参数

**响应格式**: `ResponseEntity<List<ApprovalHistoryResponse>>`

#### ApprovalHistoryResponse 字段说明

| 字段名           | 类型            | 说明             |
|------------------|-----------------|------------------|
| id               | String          | 审批记录ID       |
| approverName     | String          | 审批人姓名       |
| approverType     | String          | 审批人类型       |
| approvalAction   | String          | 审批动作         |
| approvalComment  | String          | 审批意见         |
| approvalTime     | LocalDateTime   | 审批时间         |
| approvalLevel    | Integer         | 审批级别         |
| isFinalApproval  | Boolean         | 是否为最终审批   |
| levelName        | String          | 级别名称（前端显示用） |
| approvers        | String[]        | 审批人列表（前端显示用） |
| confirmedApprover| String          | 确认审批人（前端显示用） |

### 响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": "approval001",
      "approverName": "张三",
      "approverType": "自选审批人",
      "approvalAction": "APPROVED",
      "approvalComment": "同意：排课正常，无异议",
      "approvalTime": "2025-07-21T11:20:00",
      "approvalLevel": 1,
      "isFinalApproval": false,
      "levelName": "一级审批",
      "approvers": ["张三", "李四"],
      "confirmedApprover": "张三"
    },
    {
      "id": "approval002",
      "approverName": "王五",
      "approverType": "预设审批人",
      "approvalAction": "PENDING",
      "approvalComment": null,
      "approvalTime": null,
      "approvalLevel": 2,
      "isFinalApproval": true,
      "levelName": "二级审批",
      "approvers": ["王五"],
      "confirmedApprover": ""
    }
  ]
}
```

## 🔧 前端集成方案

### 1. API 服务定义

在 `src/api/roomBookingManagement.js` 中添加：

```javascript
/**
 * 获取预约审批历史
 * @param {string} bookingId 预约ID
 * @returns {Promise} 审批历史数据
 */
export function getApprovalHistory(bookingId) {
  return request({
    url: `/api/room-booking/approval-history/${bookingId}`,
    method: 'get'
  })
}
```

### 2. 前端调用实现

修改 `MyBookings.vue` 中的 `handleViewAuditDetail` 方法：

```javascript
import { getApprovalHistory } from '@/api/roomBookingManagement'

async function handleViewAuditDetail(row) {
  try {
    const response = await getApprovalHistory(row.id)
    if (response.code === 200) {
      // 转换数据格式以适配弹出框组件
      const approvalSteps = response.data.map(item => ({
        levelName: item.levelName,
        approvers: item.approvers,
        confirmedApprover: item.confirmedApprover,
        approvalTime: item.approvalTime ? 
          new Date(item.approvalTime).toLocaleString('zh-CN') : '/',
        comment: item.approvalComment || '/'
      }))

      currentRecord.value = {
        reservationTitle: row.reservationName,
        userName: row.applicantName,
        borrowPeriodText: row.reservationPeriod,
        borrowDesc: row.description,
        participants: [], // 可从其他接口获取
        remark: '', // 可从其他接口获取
        approvalStatus: row.approvalStatus,
        approvalSteps: approvalSteps
      }
      auditDialogVisible.value = true
    } else {
      ElMessage.error('获取审批历史失败：' + response.message)
    }
  } catch (error) {
    console.error('获取审批历史失败：', error)
    ElMessage.error('获取审批历史失败')
  }
}
```

## 🚀 实现优势

1. **数据准确性**: 使用真实的后端数据替代模拟数据
2. **实时性**: 显示最新的审批状态和历史记录
3. **权限控制**: 后端验证用户权限，确保数据安全
4. **数据完整性**: 包含完整的审批流程信息

## ⚠️ 注意事项

1. **权限验证**: 接口会验证用户是否有权限查看该预约的审批历史
2. **数据格式**: 前端需要将后端返回的时间格式转换为本地显示格式
3. **错误处理**: 需要处理接口调用失败的情况
4. **加载状态**: 建议添加加载状态提示用户数据正在获取中

## 📋 实施步骤

1. ✅ **接口已存在**: 后端审批历史接口已经实现
2. ⏳ **前端集成**: 需要在前端调用真实接口替代模拟数据
3. ⏳ **测试验证**: 验证数据显示正确性和用户体验
4. ⏳ **错误处理**: 完善异常情况的处理逻辑

---

## 💡 总结

项目中已经存在完整的审批历史查询接口，只需要在前端的 `handleViewAuditDetail` 方法中调用 `/api/room-booking/approval-history/{bookingId}` 接口，将返回的数据格式化后传递给审核详情弹出框组件即可实现功能。