# 后端代码优化测试指南

## 一、优化内容概述

### 已完成的优化：
1. **全局异常处理机制** - 统一处理所有异常，返回标准化错误响应
2. **错误码体系** - 建立了完整的错误码枚举系统
3. **响应结构优化** - 增强了ResponseEntity，支持时间戳和更多错误信息
4. **安全性增强** - 修复了密码重置流程，增加了验证码机制
5. **输入验证** - 添加了DTO验证注解
6. **Controller层优化** - 移除了try-catch块，使用全局异常处理
7. **事务管理规范** - 为Service层方法添加了适当的事务注解
8. **常量管理** - 创建了SystemConstants类消除魔法值

## 二、测试要点

### 2.1 登录功能测试

**测试接口**：`POST /authentication/login`

**测试用例1 - 正常登录**：
```json
{
  "username": "admin",
  "password": "123456"
}
```

**预期响应**：
```json
{
  "code": "0",
  "message": "成功",
  "data": {
    "token": "Bearer eyJhbGciOiJIUzUxMiJ9...",
    "userId": "admin001",
    "username": "admin",
    "realName": "系统管理员",
    "customerId": "customer001"
  },
  "timestamp": "2024-01-01T10:00:00"
}
```

**测试用例2 - 用户名或密码错误**：
```json
{
  "username": "admin",
  "password": "wrongpassword"
}
```

**预期响应**：
```json
{
  "code": "1001",
  "message": "用户名或密码错误",
  "data": null,
  "timestamp": "2024-01-01T10:00:00"
}
```

### 2.2 参数验证测试

**测试接口**：`POST /authentication/forgot-password`

**测试用例1 - 参数验证失败**：
```json
{
  "username": "ad",  // 少于4位
  "phone": "12345"   // 格式错误
}
```

**预期响应**：
```json
{
  "code": "9998",
  "message": "参数校验失败",
  "data": {
    "username": "用户名格式不正确，只能包含字母、数字和下划线，长度4-20位",
    "phone": "手机号格式不正确"
  },
  "timestamp": "2024-01-01T10:00:00"
}
```

### 2.3 房间管理测试

**测试接口**：`GET /api/room/{id}`

**测试用例 - 房间不存在**：
- 请求：`GET /api/room/invalid-id`

**预期响应**：
```json
{
  "code": "3001",
  "message": "房间不存在",
  "data": null,
  "timestamp": "2024-01-01T10:00:00"
}
```

### 2.4 密码重置安全测试

**测试接口**：`POST /authentication/forgot-password`

**测试用例**：
```json
{
  "username": "admin",
  "phone": "13800138000"
}
```

**预期行为**：
1. 系统生成6位数字验证码
2. 验证码记录在日志中（开发环境）
3. 返回成功响应，不暴露用户是否存在

**预期响应**：
```json
{
  "code": "0",
  "message": "成功",
  "data": null,
  "timestamp": "2024-01-01T10:00:00"
}
```

**查看验证码**：
在后端日志中查找：`【开发环境】用户 admin 的密码重置验证码：XXXXXX`

## 三、前后端兼容性测试

### 3.1 响应格式兼容性

前端`request.js`已经更新为同时兼容新旧响应格式：
- 旧格式：`{ code: 200, message: "success", data: ... }`
- 新格式：`{ code: "0", message: "成功", data: ..., timestamp: "..." }`

### 3.2 测试步骤

1. **启动后端服务**：
   ```bash
   cd backend
   mvn spring-boot:run
   ```

2. **启动前端服务**：
   ```bash
   npm run dev
   ```

3. **测试登录流程**：
   - 访问 http://localhost:5173/login
   - 使用用户名：admin，密码：123456
   - 验证是否能正常登录

4. **测试错误处理**：
   - 使用错误的密码登录
   - 验证错误信息是否正确显示

## 四、性能验证

### 4.1 事务优化验证

查询操作已添加`@Transactional(readOnly = true)`，可通过以下方式验证：

1. 开启SQL日志：
   ```properties
   spring.jpa.show-sql=true
   spring.jpa.properties.hibernate.format_sql=true
   ```

2. 观察查询操作是否使用了只读事务

### 4.2 响应时间测试

使用Postman或其他工具测试API响应时间，验证优化后的性能：
- 目标：普通查询 < 200ms
- 目标：复杂查询 < 500ms

## 五、安全性验证

### 5.1 SQL注入防护

测试参数中包含特殊字符：
```json
{
  "roomName": "test'; DROP TABLE rooms; --"
}
```

验证系统是否正确处理，不执行恶意SQL。

### 5.2 敏感信息保护

验证日志中不包含：
- 用户密码
- JWT Token完整内容
- 其他敏感信息

## 六、注意事项

1. **数据库连接**：确保数据库配置正确
2. **JWT密钥**：生产环境需要修改JWT密钥
3. **验证码发送**：生产环境需要集成真实的短信服务
4. **日志级别**：生产环境应调整日志级别，避免暴露敏感信息

## 七、问题排查

如果遇到问题，请检查：
1. 后端日志：`backend/backend.log`
2. 浏览器控制台错误信息
3. 网络请求响应内容

常见问题：
- 401错误：Token过期或无效
- 400错误：参数验证失败
- 500错误：服务器内部错误，查看后端日志