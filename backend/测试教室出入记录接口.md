# 教室出入记录接口测试文档

## 测试环境准备

### 1. 数据库表创建
执行以下SQL脚本创建教室出入记录表：
```sql
-- 位置：backend/src/main/resources/room_access_record_table.sql
```

### 2. 测试数据准备
表中已包含示例数据，包括：
- 5条不同类型的出入记录
- 涵盖不同的用户类型（教师、学生）
- 不同的开门方式（刷卡、人脸识别、按钮）
- 不同的通行类型（预约权限、永久权限）

## 接口测试用例

### 1. 获取教室借用记录列表
**接口**: `POST /api/room-booking/access-records`

**测试用例1**: 基本分页查询
```json
{
  "pageNum": 1,
  "pageSize": 10
}
```

**预期结果**: 返回分页的出入记录列表

**测试用例2**: 按时间范围筛选
```json
{
  "pageNum": 1,
  "pageSize": 10,
  "startTime": "2024-08-04 00:00:00",
  "endTime": "2024-08-04 23:59:59"
}
```

**测试用例3**: 按开门方式筛选
```json
{
  "pageNum": 1,
  "pageSize": 10,
  "openMethod": "刷卡"
}
```

**测试用例4**: 按基础信息搜索
```json
{
  "pageNum": 1,
  "pageSize": 10,
  "basicInfo": "张三"
}
```

### 2. 获取教室借用统计信息
**接口**: `GET /api/room-booking/access-records/stats`

**测试用例1**: 无参数统计（默认最近一个月）
```
GET /api/room-booking/access-records/stats
```

**测试用例2**: 指定时间范围统计
```
GET /api/room-booking/access-records/stats?startTime=2024-08-01 00:00:00&endTime=2024-08-31 23:59:59
```

**预期结果**: 返回统计信息包括：
- 总记录数
- 今日记录数
- 使用教室数
- 使用人数
- 各种类型的统计数据

### 3. 获取教室实时使用状态
**接口**: `GET /api/room-booking/access-records/room-status`

**测试用例1**: 查询所有教室状态
```
GET /api/room-booking/access-records/room-status
```

**测试用例2**: 查询指定区域教室状态
```
GET /api/room-booking/access-records/room-status?areaId=area001
```

**预期结果**: 返回教室状态列表包括：
- 教室基本信息
- 使用状态（使用中/空闲）
- 当前使用人数
- 最后通行时间
- 当前预约信息

### 4. 导出教室借用记录
**接口**: `POST /api/room-booking/access-records/export`

**测试用例1**: 导出当前页
```json
{
  "exportType": "current",
  "pageNum": 1,
  "pageSize": 10
}
```

**测试用例2**: 导出全部数据
```json
{
  "exportType": "all",
  "startTime": "2024-08-01 00:00:00",
  "endTime": "2024-08-31 23:59:59"
}
```

**预期结果**: 返回文件下载信息

## 功能验证点

### 1. 数据安全性
- [x] 租户隔离：所有查询都包含客户域ID过滤
- [x] 权限控制：通过SecurityUtil获取当前用户信息
- [x] 参数验证：对输入参数进行有效性检查

### 2. 查询性能
- [x] 分页查询：支持分页减少数据传输
- [x] 索引优化：关键字段已建立索引
- [x] 条件筛选：支持多种筛选条件

### 3. 数据完整性
- [x] 关联查询：正确关联用户和教室信息
- [x] 冗余数据：包含必要的冗余字段提高查询效率
- [x] 时间格式：统一使用LocalDateTime处理时间

### 4. 业务逻辑
- [x] 状态判断：根据最后通行时间判断教室使用状态
- [x] 统计计算：准确计算各种统计数据
- [x] 时间处理：正确处理时间范围查询

## 错误处理测试

### 1. 参数错误
- 时间格式错误
- 分页参数超出范围
- 必填参数缺失

### 2. 数据不存在
- 查询不存在的教室
- 查询不存在的用户
- 时间范围内无数据

### 3. 系统异常
- 数据库连接失败
- 权限不足
- 服务器内部错误

## 注意事项

1. **数据库表结构**: 确保tb_room_access_record表已正确创建
2. **权限配置**: 确保接口有正确的权限配置
3. **租户隔离**: 所有查询都需要包含客户域ID
4. **性能监控**: 大数据量时注意查询性能
5. **数据同步**: 如果是从门禁系统同步数据，需要考虑数据延迟问题

## 后续优化建议

1. **缓存机制**: 对频繁查询的统计数据进行缓存
2. **异步处理**: 大批量数据导出使用异步处理
3. **实时更新**: 考虑使用WebSocket推送实时状态更新
4. **数据归档**: 定期归档历史数据提高查询性能
5. **监控告警**: 添加接口调用监控和异常告警