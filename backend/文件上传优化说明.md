# 文件上传优化说明

## 优化概述

为了解决用户信息管理中文件重复上传的问题，我们实现了一套基于SHA-256哈希的文件去重系统。该系统能够：

1. **防止重复存储**：相同的文件只存储一份物理文件
2. **支持秒传**：已存在的文件无需重新上传，直接返回结果
3. **保留元数据**：完整记录文件的原始信息
4. **引用计数管理**：追踪文件使用情况，支持安全删除

## 技术实现

### 1. 后端实现

#### 数据库设计

创建了两个新表：

- **sys_file_enhanced**：增强的文件信息表
  - 存储文件的完整元数据（原始名称、大小、MIME类型等）
  - 使用文件哈希作为唯一索引
  - 包含引用计数字段

- **sys_file_reference**：文件引用关系表
  - 记录文件与实体的关联关系
  - 支持多对多关系
  - 便于追踪文件使用情况

#### API接口

- **POST /api/upload/v2/check**：检查文件是否已存在
- **POST /api/upload/v2/upload**：上传文件（支持秒传）
- **POST /api/upload/v2/reference**：更新文件引用
- **GET /api/upload/v2/statistics**：获取文件统计信息

#### 核心功能

1. **文件去重检查**
   ```java
   // 通过文件哈希和大小判断文件是否已存在
   Optional<SysFileEnhanced> existingFile = fileRepository
       .findByFileHashAndFileSizeAndIsDeletedFalse(fileHash, fileSize);
   ```

2. **秒传支持**
   - 如果文件已存在，直接返回文件信息
   - 增加引用计数
   - 无需重复上传

3. **引用计数管理**
   - 新增引用时计数+1
   - 删除引用时计数-1
   - 计数为0时可安全删除物理文件

### 2. 前端实现

#### 文件哈希计算

使用Web Crypto API在浏览器端计算文件SHA-256哈希：

```javascript
const hashBuffer = await crypto.subtle.digest('SHA-256', arrayBuffer);
const hashHex = Array.from(new Uint8Array(hashBuffer))
    .map(b => b.toString(16).padStart(2, '0')).join('');
```

#### 增强上传组件

创建了 `useFileUploadEnhanced` 组合式函数，提供：

- 文件类型和大小验证
- 哈希计算进度显示
- 秒传检测和处理
- 上传进度跟踪
- 错误处理

#### 用户界面优化

- 显示文件特征计算进度
- 秒传时显示特殊提示
- 支持大文件分片计算哈希

## 使用示例

### 在组件中使用

```javascript
// 初始化增强文件上传
const avatarUpload = useFileUploadEnhanced({
  maxSize: 5 * 1024 * 1024, // 5MB
  allowedTypes: ['image/jpeg', 'image/png', 'image/gif'],
  category: 'avatar',
  onSuccess: (result) => {
    // 处理上传成功
    userForm.avatar = result.url
  }
})

// 处理文件选择
const handleAvatarChange = async (file) => {
  await avatarUpload.handleUpload(file.raw)
}
```

## 优化效果

1. **存储空间节省**：相同文件只存储一份
2. **上传速度提升**：已存在文件实现秒传
3. **用户体验改善**：显示上传进度和状态
4. **数据完整性**：保留完整的文件元数据

## 后续优化建议

1. **定期清理任务**：删除引用计数为0且超过保留期的文件
2. **缩略图生成**：为图片文件生成缩略图
3. **文件预览**：支持更多文件类型的在线预览
4. **分片上传**：支持大文件分片上传
5. **CDN集成**：将文件存储到CDN以提升访问速度