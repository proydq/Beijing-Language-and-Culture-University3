# 权限控制实施计划

## 已完成的控制器权限配置

### 1. SysUserController (用户管理)
- ✅ 已添加权限注解
- 使用权限: USER_SEARCH, USER_VIEW, USER_ADD, USER_EDIT, USER_DELETE, USER_RESET_PWD, USER_ASSIGN_ROLE, USER_MANAGE

### 2. RoleManagementController (角色管理)
- ✅ 已添加权限注解
- 使用权限: ROLE_SEARCH, ROLE_ADD, ROLE_EDIT, ROLE_DELETE, ROLE_ASSIGN_PERM, ROLE_MANAGE, PERMISSION_SEARCH

### 3. RoomController (教室管理)
- ✅ 已添加权限注解
- 使用权限: ROOM_SEARCH, ROOM_VIEW, ROOM_ADD, ROOM_EDIT, ROOM_DELETE, ROOM_BOOK, ROOM_MANAGE, BOOKING_CREATE

### 4. RoomBookingController (教室预订)
- ✅ 已添加权限注解
- 使用权限: BOOKING_VIEW, BOOKING_SEARCH, BOOKING_CREATE, BOOKING_CANCEL, BOOKING_MANAGE, ROOM_BOOK, ROOM_CANCEL_BOOK, REPORT_VIEW, REPORT_EXPORT

### 5. UserPermissionController (权限查询)
- ✅ 已添加权限注解
- 使用权限: isAuthenticated() (仅需要登录)

## 待完成的控制器权限配置

### 需要添加权限控制的控制器：

1. **FileUploadEnhancedController** (文件上传增强)
   - 建议权限: FILE_UPLOAD, FILE_MANAGE

2. **AuthenticationController** (认证控制器)
   - 登录、忘记密码等接口保持开放
   - 其他接口需要 isAuthenticated()

3. **RoomBookingApprovalController** (预订审批)
   - 建议权限: BOOKING_APPROVE, BOOKING_REJECT, BOOKING_MANAGE

4. **RoomScheduleController** (教室日程)
   - 建议权限: ROOM_SEARCH, ROOM_VIEW, BOOKING_VIEW

5. **BlacklistController** (黑名单管理)
   - 建议权限: BLACKLIST_MANAGE, BLACKLIST_VIEW, BLACKLIST_ADD, BLACKLIST_DELETE

6. **ViolationSettingController** (违规设置)
   - 建议权限: SYSTEM_CONFIG, VIOLATION_MANAGE

7. **SchemeManagementController** (方案管理)
   - 建议权限: SCHEME_MANAGE, SCHEME_VIEW, SCHEME_ADD, SCHEME_EDIT, SCHEME_DELETE

8. **RecycleBinController** (回收站)
   - 建议权限: RECYCLE_VIEW, RECYCLE_RESTORE, RECYCLE_DELETE

9. **ContinuousBookingSettingController** (连续预订设置)
   - 建议权限: SYSTEM_CONFIG, BOOKING_CONFIG

10. **AreaController** (区域管理)
    - 建议权限: AREA_MANAGE, AREA_VIEW, AREA_ADD, AREA_EDIT, AREA_DELETE

11. **BookingTimeValidationController** (预订时间验证)
    - 建议权限: isAuthenticated() (所有登录用户)

12. **BookingTimeRuleController** (预订时间规则)
    - 建议权限: SYSTEM_CONFIG, BOOKING_CONFIG

13. **UserBookingLimitController** (用户预订限制)
    - 建议权限: SYSTEM_CONFIG, BOOKING_CONFIG

14. **BookingPersonnelPermissionController** (预订人员权限)
    - 建议权限: BOOKING_PERMISSION_MANAGE

15. **FileUploadController** (文件上传)
    - 建议权限: FILE_UPLOAD

16. **TitleController** (职称管理)
    - 建议权限: TITLE_MANAGE, TITLE_VIEW, TITLE_ADD, TITLE_EDIT, TITLE_DELETE

17. **PositionController** (职位管理)
    - 建议权限: POSITION_MANAGE, POSITION_VIEW, POSITION_ADD, POSITION_EDIT, POSITION_DELETE

18. **OrganizationController** (组织机构管理)
    - 建议权限: ORG_MANAGE, ORG_VIEW, ORG_ADD, ORG_EDIT, ORG_DELETE

## 需要添加到PermissionConstants的新权限

```java
// 文件管理权限
public static final class File {
    public static final String UPLOAD = "FILE_UPLOAD";
    public static final String MANAGE = "FILE_MANAGE";
}

// 黑名单管理权限
public static final class Blacklist {
    public static final String MANAGE = "BLACKLIST_MANAGE";
    public static final String VIEW = "BLACKLIST_VIEW";
    public static final String ADD = "BLACKLIST_ADD";
    public static final String DELETE = "BLACKLIST_DELETE";
}

// 违规管理权限
public static final class Violation {
    public static final String MANAGE = "VIOLATION_MANAGE";
}

// 方案管理权限
public static final class Scheme {
    public static final String MANAGE = "SCHEME_MANAGE";
    public static final String VIEW = "SCHEME_VIEW";
    public static final String ADD = "SCHEME_ADD";
    public static final String EDIT = "SCHEME_EDIT";
    public static final String DELETE = "SCHEME_DELETE";
}

// 回收站权限
public static final class Recycle {
    public static final String VIEW = "RECYCLE_VIEW";
    public static final String RESTORE = "RECYCLE_RESTORE";
    public static final String DELETE = "RECYCLE_DELETE";
}

// 区域管理权限
public static final class Area {
    public static final String MANAGE = "AREA_MANAGE";
    public static final String VIEW = "AREA_VIEW";
    public static final String ADD = "AREA_ADD";
    public static final String EDIT = "AREA_EDIT";
    public static final String DELETE = "AREA_DELETE";
}

// 预订配置权限
public static final class BookingConfig {
    public static final String CONFIG = "BOOKING_CONFIG";
    public static final String PERMISSION_MANAGE = "BOOKING_PERMISSION_MANAGE";
}

// 职称管理权限
public static final class Title {
    public static final String MANAGE = "TITLE_MANAGE";
    public static final String VIEW = "TITLE_VIEW";
    public static final String ADD = "TITLE_ADD";
    public static final String EDIT = "TITLE_EDIT";
    public static final String DELETE = "TITLE_DELETE";
}

// 职位管理权限
public static final class Position {
    public static final String MANAGE = "POSITION_MANAGE";
    public static final String VIEW = "POSITION_VIEW";
    public static final String ADD = "POSITION_ADD";
    public static final String EDIT = "POSITION_EDIT";
    public static final String DELETE = "POSITION_DELETE";
}

// 组织机构权限
public static final class Organization {
    public static final String MANAGE = "ORG_MANAGE";
    public static final String VIEW = "ORG_VIEW";
    public static final String ADD = "ORG_ADD";
    public static final String EDIT = "ORG_EDIT";
    public static final String DELETE = "ORG_DELETE";
}
```

## 实施步骤

1. **更新PermissionConstants**
   - 添加所有新的权限常量定义

2. **批量添加权限注解**
   - 为每个控制器的每个方法添加适当的@PreAuthorize注解
   - 确保import语句正确

3. **数据库权限数据初始化**
   - 创建SQL脚本插入所有新权限到sys_permission表
   - 为不同角色分配适当的权限

4. **测试验证**
   - 创建测试脚本验证每个接口的权限控制
   - 确保没有权限的用户无法访问受保护的接口

## 注意事项

1. **开放接口**
   - 登录、注册、忘记密码等接口不需要权限控制
   - 公共查询接口可以只要求登录(isAuthenticated())

2. **权限粒度**
   - 查看类操作使用VIEW权限
   - 创建类操作使用ADD权限
   - 修改类操作使用EDIT权限
   - 删除类操作使用DELETE权限
   - 管理类操作使用MANAGE权限（包含所有子权限）

3. **权限组合**
   - 使用or连接多个权限，如: hasAuthority('ROOM_VIEW') or hasAuthority('ROOM_MANAGE')
   - MANAGE权限应该包含该模块的所有操作权限