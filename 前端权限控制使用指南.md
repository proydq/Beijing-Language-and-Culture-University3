# 前端权限控制使用指南

## 快速开始

### 1. 按钮权限控制

在需要权限控制的按钮上添加 `v-permission` 指令：

```vue
<!-- 用户管理页面 -->
<template>
  <div class="header-actions">
    <!-- 新增按钮：需要USER_ADD权限 -->
    <el-button 
      type="primary" 
      v-permission="'USER_ADD'"
      @click="handleAdd"
    >
      <el-icon><plus /></el-icon>
      新增用户
    </el-button>

    <!-- 导入按钮：需要USER_IMPORT权限 -->
    <el-button 
      type="warning" 
      v-permission="'USER_IMPORT'"
      @click="handleImport"
    >
      <el-icon><upload /></el-icon>
      导入
    </el-button>

    <!-- 导出按钮：需要USER_EXPORT权限 -->
    <el-button 
      type="info" 
      v-permission="'USER_EXPORT'"
      @click="handleExport"
    >
      <el-icon><download /></el-icon>
      导出
    </el-button>
  </div>
</template>
```

### 2. 表格操作列权限控制

```vue
<el-table-column label="操作" width="200" fixed="right">
  <template #default="{ row }">
    <!-- 查看按钮：需要USER_VIEW权限 -->
    <el-button 
      link 
      type="primary" 
      v-permission="'USER_VIEW'"
      @click="handleView(row)"
    >
      查看
    </el-button>
    
    <!-- 编辑按钮：需要USER_EDIT权限 -->
    <el-button 
      link 
      type="primary" 
      v-permission="'USER_EDIT'"
      @click="handleEdit(row)"
    >
      编辑
    </el-button>
    
    <!-- 删除按钮：需要USER_DELETE权限 -->
    <el-button 
      link 
      type="danger" 
      v-permission="'USER_DELETE'"
      @click="handleDelete(row)"
    >
      删除
    </el-button>
    
    <!-- 重置密码：需要USER_RESET_PWD权限 -->
    <el-button 
      link 
      type="warning" 
      v-permission="'USER_RESET_PWD'"
      @click="handleResetPassword(row)"
    >
      重置密码
    </el-button>
  </template>
</el-table-column>
```

### 3. 菜单权限控制

在组件中使用过滤后的菜单：

```vue
<template>
  <el-menu :default-active="activeMenu">
    <template v-for="menu in filteredMenus" :key="menu.path">
      <!-- 有子菜单的情况 -->
      <el-sub-menu v-if="menu.children" :index="menu.title">
        <template #title>
          <el-icon><component :is="menu.icon" /></el-icon>
          <span>{{ menu.title }}</span>
        </template>
        <el-menu-item 
          v-for="child in menu.children" 
          :key="child.path"
          :index="child.path"
          @click="navigateTo(child.path)"
        >
          {{ child.title }}
        </el-menu-item>
      </el-sub-menu>
      
      <!-- 没有子菜单的情况 -->
      <el-menu-item v-else :index="menu.path" @click="navigateTo(menu.path)">
        <el-icon><component :is="menu.icon" /></el-icon>
        <span>{{ menu.title }}</span>
      </el-menu-item>
    </template>
  </el-menu>
</template>

<script setup>
import { computed } from 'vue'
import { useRouter } from 'vue-router'
import { menuConfig, filterMenuByPermission } from '@/config/menu'
import { hasPermission } from '@/utils/permission'

const router = useRouter()

// 过滤后的菜单
const filteredMenus = computed(() => {
  return filterMenuByPermission([...menuConfig], permission => hasPermission(permission))
})

// 导航方法
const navigateTo = (path) => {
  router.push(path)
}
</script>
```

### 4. 条件渲染权限控制

使用 `v-if` 配合权限判断函数：

```vue
<template>
  <!-- 管理员专属功能区 -->
  <div v-if="isAdmin" class="admin-section">
    <h3>系统管理</h3>
    <!-- 管理员功能 -->
  </div>

  <!-- 根据权限显示不同内容 -->
  <div v-if="canManageUsers" class="user-management">
    <h3>用户管理功能</h3>
    <!-- 用户管理相关功能 -->
  </div>

  <!-- 多权限判断 -->
  <div v-if="hasAnyPermission('ROOM_BOOK', 'BOOKING_CREATE')">
    <el-button @click="bookRoom">预订教室</el-button>
  </div>
</template>

<script setup>
import { computed } from 'vue'
import { useUserStore } from '@/stores/user'
import { hasPermission, hasAnyPermission, PERMISSIONS } from '@/utils/permission'

const userStore = useUserStore()

// 是否是管理员
const isAdmin = computed(() => userStore.isAdmin)

// 是否可以管理用户
const canManageUsers = computed(() => {
  return hasPermission(PERMISSIONS.USER.MANAGE)
})
</script>
```

### 5. 复杂权限场景

```vue
<template>
  <!-- 场景1：需要多个权限之一 -->
  <el-button 
    v-permission="['USER_EDIT', 'USER_MANAGE', 'SYSTEM_MANAGE']"
    @click="editUser"
  >
    编辑用户（多权限之一）
  </el-button>

  <!-- 场景2：需要全部权限 -->
  <el-button 
    v-permission.all="['USER_VIEW', 'ROOM_VIEW']"
    @click="viewAll"
  >
    查看全部（需要所有权限）
  </el-button>

  <!-- 场景3：角色和权限组合 -->
  <div v-if="isAdminOrHasPermission">
    <h3>特殊功能区</h3>
  </div>
</template>

<script setup>
import { computed } from 'vue'
import { useUserStore } from '@/stores/user'
import { hasPermission } from '@/utils/permission'

const userStore = useUserStore()

// 组合判断：管理员角色或有特定权限
const isAdminOrHasPermission = computed(() => {
  return userStore.hasRole('admin') || hasPermission('SYSTEM_MANAGE')
})
</script>
```

## 实际页面改造示例

### 改造前的用户管理页面：

```vue
<div class="header-actions">
  <el-button type="primary" @click="handleAdd">新增用户</el-button>
  <el-button type="warning" @click="handleImport">导入</el-button>
  <el-button type="info" @click="handleExport">导出</el-button>
</div>
```

### 改造后的用户管理页面：

```vue
<div class="header-actions">
  <el-button 
    type="primary" 
    v-permission="'USER_ADD'"
    @click="handleAdd"
  >
    新增用户
  </el-button>
  <el-button 
    type="warning" 
    v-permission="'USER_IMPORT'"
    @click="handleImport"
  >
    导入
  </el-button>
  <el-button 
    type="info" 
    v-permission="'USER_EXPORT'"
    @click="handleExport"
  >
    导出
  </el-button>
</div>
```

## 权限常量速查表

```javascript
// 用户管理
USER_MANAGE      // 用户管理（包含所有子权限）
USER_SEARCH      // 用户查询
USER_VIEW        // 用户查看
USER_ADD         // 用户新增
USER_EDIT        // 用户编辑
USER_DELETE      // 用户删除
USER_RESET_PWD   // 重置密码
USER_ASSIGN_ROLE // 分配角色
USER_EXPORT      // 用户导出
USER_IMPORT      // 用户导入

// 教室管理
ROOM_MANAGE      // 教室管理（包含所有子权限）
ROOM_SEARCH      // 教室查询
ROOM_VIEW        // 教室查看
ROOM_ADD         // 教室新增
ROOM_EDIT        // 教室编辑
ROOM_DELETE      // 教室删除
ROOM_BOOK        // 教室预订
ROOM_CANCEL_BOOK // 取消预订
ROOM_APPROVE     // 预订审批

// 预订管理
BOOKING_MANAGE   // 预订管理
BOOKING_SEARCH   // 预订查询
BOOKING_VIEW     // 预订查看
BOOKING_CREATE   // 创建预订
BOOKING_EDIT     // 编辑预订
BOOKING_CANCEL   // 取消预订
BOOKING_APPROVE  // 审批预订
BOOKING_REJECT   // 拒绝预订

// 更多权限请查看 src/utils/permission.js
```

## 最佳实践

1. **统一使用权限常量**：使用 `PERMISSIONS` 对象而不是硬编码字符串
2. **合理使用权限继承**：MANAGE权限包含所有子权限，避免重复判断
3. **优雅降级**：无权限时隐藏按钮，而不是禁用
4. **友好提示**：执行操作前检查权限，给出明确提示
5. **性能优化**：大量权限判断时使用计算属性缓存结果

## 注意事项

1. 前端权限控制只是改善用户体验，真正的安全控制必须在后端实现
2. 权限变更后需要用户重新登录才能生效
3. 确保权限常量与后端保持一致
4. 测试时注意不同角色的权限差异