# 前端响应处理规范

## 一、后端统一响应格式

后端所有接口现已统一使用以下响应格式：

```json
{
  "code": "0",           // 字符串类型，成功为"0"，失败为具体错误码
  "message": "成功",     // 响应消息
  "data": {},           // 响应数据
  "timestamp": "2024-01-01T10:00:00"  // 响应时间
}
```

## 二、前端处理机制

### 2.1 自动转换机制

前端的 `request.js` 和 `api/index.js` 已经配置了响应拦截器，会自动进行以下转换：

1. **成功响应转换**：
   - 后端返回 `code: "0"` → 前端自动转换为 `code: 200`
   - 保证前端代码统一使用 `code === 200` 判断成功

2. **错误码转换**：
   - 字符串错误码自动转换为数字
   - 例如：`"1001"` → `1001`

### 2.2 使用示例

#### 1. 使用 request.js（推荐）

```javascript
import request from '@/utils/request'

// GET 请求
const response = await request.get('/api/room/1')
if (response.code === 200) {
  // 成功处理
  console.log(response.data)
} else {
  // 错误已经被拦截器处理
}

// POST 请求
try {
  const response = await request.post('/api/room', roomData)
  // 这里只会收到成功的响应，code已经是200
  console.log(response.data)
} catch (error) {
  // 错误会被自动处理并显示
  console.error(error.message)
}
```

#### 2. 使用 apiHelper.js 工具函数

```javascript
import { handleApiResponse, isSuccess } from '@/utils/apiHelper'

// 方式1：使用 handleApiResponse
const data = await handleApiResponse(
  roomAPI.create(roomData),
  {
    successMessage: '创建成功',
    errorMessage: '创建失败',
    showSuccess: true
  }
)
if (data) {
  // 处理成功返回的数据
}

// 方式2：手动检查
const response = await roomAPI.list()
if (isSuccess(response)) {
  // 成功处理
}
```

#### 3. 在组件中使用（推荐模式）

```javascript
export default {
  methods: {
    async loadData() {
      this.loading = true
      try {
        const response = await roomAPI.list()
        // 成功时 code 一定是 200
        if (response.code === 200) {
          this.dataList = response.data
        }
      } catch (error) {
        // 错误已被拦截器处理，这里可以做额外处理
        this.$message.error('加载失败')
      } finally {
        this.loading = false
      }
    }
  }
}
```

## 三、错误码对照表

| 错误码 | 说明 | 处理建议 |
|--------|------|----------|
| 0 | 成功 | 自动转换为200 |
| 1001 | 用户名或密码错误 | 提示用户重新输入 |
| 1004 | 令牌无效 | 自动跳转登录页 |
| 1005 | 令牌已过期 | 自动跳转登录页 |
| 3001 | 房间不存在 | 提示并返回列表 |
| 4002 | 预约时间冲突 | 提示选择其他时间 |
| 9998 | 参数错误 | 显示具体验证错误 |
| 9999 | 系统异常 | 提示稍后重试 |

## 四、注意事项

1. **不要直接判断 `code === '0'`**
   - 错误示例：`if (response.code === '0')`
   - 正确示例：`if (response.code === 200)`

2. **统一使用 request.js**
   - 避免直接使用 axios
   - 确保响应格式统一处理

3. **错误处理**
   - 拦截器会自动处理常见错误
   - 组件中可以根据需要添加额外处理

4. **ElMessage 使用**
   - 成功消息使用：`ElMessage.success()`
   - 错误消息使用：`ElMessage.error()`
   - 避免成功响应显示红色警告

## 五、迁移指南

如果你的代码中有以下情况，请按照说明修改：

### 1. 直接判断字符串 "0"
```javascript
// 旧代码
if (response.code === '0') { }

// 新代码
if (response.code === 200) { }
```

### 2. 使用其他成功码
```javascript
// 旧代码
if (response.code === 0 || response.code === '200') { }

// 新代码
if (response.code === 200) { }
```

### 3. 错误码判断
```javascript
// 旧代码
if (response.code === '1001') { }

// 新代码（错误码已转换为数字）
if (response.code === 1001) { }
```