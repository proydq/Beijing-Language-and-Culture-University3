# 教室借用记录接口文档

## 概述

教室借用记录模块用于记录和管理所有教室的借用历史，包括通过预约权限和永久权限进入教室的记录。本文档定义了该模块所需的后端接口规范。

## 核心功能

1. **记录查询**：支持多条件筛选查询借用记录
2. **楼栋筛选**：支持按楼栋/楼层/教室筛选记录
3. **数据导出**：支持导出当前页和全部数据
4. **权限管理**：区分预约权限和永久权限的通行记录
5. **统计分析**：提供教室预约次数、累计时长、累计人数等统计数据

## 接口清单

### 1. 获取教室借用记录列表

**接口地址**: `/api/room-booking/access-records`

**请求方式**: POST

**接口描述**: 分页查询教室借用记录，支持多条件筛选

**请求参数**:
```json
{
  "pageNum": 1,              // 页码，默认1
  "pageSize": 10,            // 每页条数，默认10
  "areaId": "string",        // 区域ID（可选，用于楼栋/楼层筛选）
  "roomId": "string",        // 教室ID（可选）
  "basicInfo": "string",     // 基础信息（姓名/工号/联系方式，可选）
  "startTime": "2024-06-27 00:00:00", // 开始时间（可选）
  "endTime": "2024-06-27 23:59:59",   // 结束时间（可选）
  "openMethod": "string",    // 开门方式（刷卡/人脸识别/按钮，可选）
  "accessType": "string"     // 通行类型（预约权限/永久权限，可选）
}
```

**返回参数**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 100,            // 总记录数
    "pages": 10,             // 总页数
    "pageNum": 1,            // 当前页码
    "pageSize": 10,          // 每页条数
    "list": [
      {
        "id": "string",                    // 记录ID
        "roomId": "string",                // 教室ID
        "roomName": "A-101",               // 教室名称
        "buildingName": "教学楼A",        // 楼栋名称
        "floor": "1F",                     // 楼层
        "userId": "string",                // 用户ID
        "name": "张三",                    // 姓名
        "gender": "男",                    // 性别
        "employeeId": "T001",              // 工号
        "phone": "13800138000",            // 联系方式
        "department": "计算机学院",        // 部门
        "userType": "教师",                // 用户类型（教师/学生）
        "openMethod": "刷卡",              // 开门方式
        "accessTime": "2024-06-27 08:00:00", // 通行时间
        "accessType": "预约权限",          // 通行类型
        "bookingId": "string",             // 预约ID（预约权限时有值）
        "bookingName": "计算机基础课程",   // 预约名称（预约权限时有值）
        "bookingPeriod": "08:00-10:00",    // 预约时段（预约权限时有值）
        "deviceId": "string",              // 门禁设备ID
        "deviceName": "A101门禁",          // 门禁设备名称
        "createTime": "2024-06-27 08:00:00" // 记录创建时间
      }
    ]
  }
}
```

### 2. 导出教室借用记录

**接口地址**: `/api/room-booking/access-records/export`

**请求方式**: POST

**接口描述**: 导出教室借用记录为Excel文件

**请求参数**:
```json
{
  "exportType": "current",   // 导出类型：current-当前页，all-全部页
  "pageNum": 1,              // 页码（exportType为current时必填）
  "pageSize": 10,            // 每页条数（exportType为current时必填）
  "areaId": "string",        // 区域ID（可选）
  "roomId": "string",        // 教室ID（可选）
  "basicInfo": "string",     // 基础信息（可选）
  "startTime": "2024-06-27 00:00:00", // 开始时间（可选）
  "endTime": "2024-06-27 23:59:59",   // 结束时间（可选）
  "openMethod": "string",    // 开门方式（可选）
  "accessType": "string"     // 通行类型（可选）
}
```

**返回参数**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "fileName": "教室借用记录_20240627_120000.xlsx", // 文件名
    "fileUrl": "/download/temp/xxx.xlsx",           // 文件下载地址
    "fileSize": 102400,                             // 文件大小（字节）
    "recordCount": 100                              // 导出记录数
  }
}
```

### 3. 获取教室借用统计信息

**接口地址**: `/api/room-booking/access-records/stats`

**请求方式**: GET

**接口描述**: 获取教室借用记录的统计信息

**请求参数**:
```
startTime: 2024-06-01 00:00:00  // 开始时间（可选）
endTime: 2024-06-30 23:59:59    // 结束时间（可选）
areaId: string                  // 区域ID（可选）
```

**返回参数**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "totalRecords": 1000,         // 总记录数
    "todayRecords": 50,           // 今日记录数
    "totalRooms": 30,             // 使用教室数
    "totalUsers": 200,            // 使用人数
    "accessTypeStats": {          // 通行类型统计
      "预约权限": 600,
      "永久权限": 400
    },
    "openMethodStats": {          // 开门方式统计
      "刷卡": 500,
      "人脸识别": 300,
      "按钮": 200
    },
    "userTypeStats": {            // 用户类型统计
      "教师": 400,
      "学生": 600
    }
  }
}
```

### 4. 获取教室实时使用状态

**接口地址**: `/api/room-booking/access-records/room-status`

**请求方式**: GET

**接口描述**: 获取教室当前的使用状态（基于最新的进出记录）

**请求参数**:
```
areaId: string  // 区域ID（可选）
```

**返回参数**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "roomId": "string",
      "roomName": "A-101",
      "buildingName": "教学楼A",
      "floor": "1F",
      "status": "使用中",           // 使用中/空闲
      "currentUsers": 5,            // 当前使用人数
      "lastAccessTime": "2024-06-27 14:30:00", // 最后通行时间
      "currentBooking": {           // 当前预约信息（如果有）
        "bookingId": "string",
        "bookingName": "计算机基础课程",
        "applicantName": "张三",
        "bookingPeriod": "14:00-16:00"
      }
    }
  ]
}
```

### 5. 获取教室预约统计列表

**接口地址**: `/api/room-booking/access-records/booking-stats`

**请求方式**: POST

**接口描述**: 获取教室预约统计信息，包括预约次数、累计时长、累计人数等

**请求参数**:
```json
{
  "pageNum": 1,              // 页码，默认1
  "pageSize": 10,            // 每页条数，默认10
  "roomName": "string",      // 教室名称（可选，支持模糊搜索）
  "areaId": "string"         // 区域ID（可选，用于楼栋筛选）
}
```

**返回参数**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 4,              // 总记录数
    "pages": 1,              // 总页数
    "pageNum": 1,            // 当前页码
    "pageSize": 10,          // 每页条数
    "list": [
      {
        "roomId": "string",                // 教室ID
        "roomName": "B-101",               // 教室名称
        "bookingCount": 8,                 // 预约次数
        "totalDuration": 400,              // 预约累计时长（分钟）
        "totalPeople": 100                 // 累计预约人数
      },
      {
        "roomId": "string",
        "roomName": "A-101",
        "bookingCount": 5,
        "totalDuration": 300,
        "totalPeople": 40
      },
      {
        "roomId": "string",
        "roomName": "A-201",
        "bookingCount": 3,
        "totalDuration": 180,
        "totalPeople": 30
      },
      {
        "roomId": "string",
        "roomName": "B-202",
        "bookingCount": 2,
        "totalDuration": 90,
        "totalPeople": 20
      }
    ]
  }
}
```

### 6. 获取教室预约详情

**接口地址**: `/api/room-booking/access-records/room/{roomId}/details`

**请求方式**: POST

**接口描述**: 获取指定教室的详细预约记录列表，支持筛选和分页

**请求参数**:
```json
{
  "roomId": "string",              // 教室ID
  "pageNum": 1,                    // 页码，默认1
  "pageSize": 10,                  // 每页条数，默认10
  "bookingName": "string",         // 借用/预约名称（可选，支持模糊搜索）
  "auditStatus": "string",         // 审核状态（通过/审核中/拒绝，可选）
  "usageStatus": "string",         // 使用状态（未开始/进行中/已结束，可选）
  "applicantName": "string",       // 预约人（可选）
  "startTime": "2025-04-15",       // 预约开始日期（可选）
  "endTime": "2025-04-15"          // 预约结束日期（可选）
}
```

**返回参数**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "roomInfo": {
      "roomId": "string",
      "roomName": "B-101",
      "roomCode": "B101",                      // 教室编号
      "buildingName": "教学楼B",
      "floor": "1F",
      "capacity": 50,                          // 教室容量
      "equipment": "投影仪、音响、白板"          // 教室设备
    },
    "pageData": {
      "total": 1,                              // 总记录数
      "pages": 1,                              // 总页数
      "pageNum": 1,                            // 当前页码
      "pageSize": 10,                          // 每页条数
      "list": [
        {
          "id": "string",                      // 记录ID
          "bookingName": "摄影培训交流",        // 借用/预约名称
          "bookingTime": "2025.04.15 第五节次 第七节次", // 预约时间描述
          "description": "校内摄影社团培训活动，已完成申请练习。", // 描述
          "applicantName": "张华",              // 预约人
          "applicantPhone": "13800138000",      // 联系电话
          "applicantDepartment": "摄影社",      // 申请部门
          "auditStatus": "通过",                // 审核状态
          "auditStatusCode": "APPROVED",        // 审核状态码
          "usageStatus": "已结束",              // 使用状态
          "usageStatusCode": "COMPLETED",       // 使用状态码
          "bookingStartTime": "2025-04-15 14:00:00", // 预约开始时间
          "bookingEndTime": "2025-04-15 16:00:00",   // 预约结束时间
          "peopleCount": 30,                    // 参与人数
          "createTime": "2025-04-10 10:00:00",  // 创建时间
          "approvalTime": "2025-04-10 15:00:00", // 审批时间
          "approverName": "李主任",              // 审批人
          "approvalComment": "同意"              // 审批意见
        }
      ]
    }
  }
}
```

### 7. 导出教室预约详情

**接口地址**: `/api/room-booking/access-records/room/{roomId}/export`

**请求方式**: POST

**接口描述**: 导出指定教室的预约记录为Excel文件

**请求参数**:
```json
{
  "roomId": "string",              // 教室ID
  "exportType": "current",         // 导出类型：current-当前页，all-全部数据
  "pageNum": 1,                    // 页码（exportType为current时必填）
  "pageSize": 10,                  // 每页条数（exportType为current时必填）
  "bookingName": "string",         // 借用/预约名称（可选）
  "auditStatus": "string",         // 审核状态（可选）
  "usageStatus": "string",         // 使用状态（可选）
  "applicantName": "string",       // 预约人（可选）
  "startTime": "2025-04-15",       // 预约开始日期（可选）
  "endTime": "2025-04-15"          // 预约结束日期（可选）
}
```

**返回参数**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "fileName": "B101教室预约记录_20250415_120000.xlsx", // 文件名
    "fileUrl": "/download/temp/xxx.xlsx",                // 文件下载地址
    "fileSize": 51200,                                  // 文件大小（字节）
    "recordCount": 50                                   // 导出记录数
  }
}
```

## 数据库设计建议

### 教室借用记录表 (tb_room_access_record)

```sql
CREATE TABLE tb_room_access_record (
    id VARCHAR(36) PRIMARY KEY COMMENT '主键ID',
    room_id VARCHAR(36) COMMENT '教室ID',
    room_name VARCHAR(100) COMMENT '教室名称（冗余）',
    building_name VARCHAR(100) COMMENT '楼栋名称（冗余）',
    floor VARCHAR(20) COMMENT '楼层（冗余）',
    user_id VARCHAR(36) COMMENT '用户ID',
    name VARCHAR(50) COMMENT '姓名（冗余）',
    gender VARCHAR(10) COMMENT '性别（冗余）',
    employee_id VARCHAR(50) COMMENT '工号（冗余）',
    phone VARCHAR(20) COMMENT '联系方式（冗余）',
    department VARCHAR(100) COMMENT '部门（冗余）',
    user_type VARCHAR(20) COMMENT '用户类型',
    open_method VARCHAR(20) COMMENT '开门方式',
    access_time DATETIME COMMENT '通行时间',
    access_type VARCHAR(20) COMMENT '通行类型',
    booking_id VARCHAR(36) COMMENT '预约ID',
    booking_name VARCHAR(200) COMMENT '预约名称（冗余）',
    booking_period VARCHAR(100) COMMENT '预约时段（冗余）',
    device_id VARCHAR(36) COMMENT '门禁设备ID',
    device_name VARCHAR(100) COMMENT '门禁设备名称（冗余）',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    INDEX idx_room_id (room_id),
    INDEX idx_user_id (user_id),
    INDEX idx_access_time (access_time),
    INDEX idx_booking_id (booking_id)
) COMMENT='教室借用记录表';
```

## 接口实现说明

1. **数据来源**：
   - 门禁系统实时推送通行记录
   - 预约系统在用户进入时创建记录
   - 考勤系统可能也会产生相关记录

2. **权限控制**：
   - 普通用户：只能查看自己的借用记录
   - 教室管理员：可查看所管理教室的所有记录
   - 系统管理员：可查看所有记录

3. **性能优化**：
   - 建议对常用查询字段建立索引
   - 大量数据时考虑分表或归档历史数据
   - 导出功能建议异步处理，避免阻塞

4. **数据同步**：
   - 需要与门禁系统、预约系统保持数据同步
   - 建议使用消息队列确保数据一致性

## 前端对接说明

1. **列表查询**：前端需要提供筛选条件和分页参数
2. **楼栋树形结构**：前端维护楼栋树的展开/收起状态
3. **导出功能**：建议使用异步导出，展示进度条
4. **实时刷新**：可以使用WebSocket或定时轮询更新数据